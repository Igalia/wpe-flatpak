{
    "build-runtime": true,
    "id": "org.wpe.Sdk",
    "id-platform": "org.wpe.Platform",
    "branch": "stable",
    "runtime": "org.freedesktop.Platform",
    "sdk": "org.freedesktop.Sdk",
    "runtime-version": "20.08",
    "build-runtime": true,
    "sdk-extensions": [ "org.freedesktop.Sdk.Locale", "org.freedesktop.Sdk.Docs",
                        "org.freedesktop.Sdk.Extension.rust-stable" ],
    "inherit-extensions": [
        "org.freedesktop.Platform.GL",
        "org.freedesktop.Platform.Icontheme",
        "org.gtk.Gtk3theme"
    ],
    "inherit-sdk-extensions": [
        "org.freedesktop.Sdk.Extension"
    ],
    "cleanup-commands": [ "/usr/libexec/freedesktop-post.sh" ],
    "cleanup-platform-commands": [ "/usr/libexec/freedesktop-post.sh" ],

    "build-options": {
        "arch": {
            "arm": {
                "cflags": "-D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64",
                "cppflags": "-D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64",
                "cxxflags": "-D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64"
            },
            "aarch64": {
                "cflags": "-D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64",
                "cppflags": "-D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64",
                "cxxflags": "-D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64"
            }
        }
    },

    "modules": [
        {
            "name": "cmake",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/Kitware/CMake/releases/download/v3.15.5/cmake-3.15.5.tar.gz",
                    "sha256": "fbdd7cef15c0ced06bb13024bfda0ecc0dedbcaaaa6b8a5d368c75255243beb4"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'list(INSERT CMAKE_SYSTEM_LIBRARY_PATH 0 \"%{libdir}\")' >>Modules/Platform/UnixPaths.cmake",
                        "echo 'list(INSERT CMAKE_PLATFORM_IMPLICIT_LINK_DIRECTORIES 0 \"%{libdir}\")' >>Modules/Platform/UnixPaths.cmake"
                    ]
                }
            ],
            "buildsystem": "simple",
            "build-commands": [
                "./configure --prefix=${FLATPAK_DEST} --parallel=${FLATPAK_BUILDER_N_JOBS}",
                "make -j${FLATPAK_BUILDER_N_JOBS}",
                "make install"
            ]
        },
        {
            "name": "libdrm",
            "buildsystem": "meson",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://dri.freedesktop.org/libdrm/libdrm-2.4.102.tar.xz",
                    "sha256": "8bcbf9336c28e393d76c1f16d7e79e394a7fce8a2e929d52d3ad7ad8525ba05b"
                }
            ]
        },
        {
            "name": "libva",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/intel/libva/releases/download/2.8.0/libva-2.8.0.tar.bz2",
                    "sha256": "adbb1244d278908f89ccfcf254a442de6d71934565a492cb6f03caf2ed4d1ec3"
                }
            ]
        },
        {
            "name": "libva-utils",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/intel/libva-utils/releases/download/2.8.0/libva-utils-2.8.0.tar.bz2",
                    "sha256": "8acad2c16bfef408643cf4de56c324345449f202e4a3a5b012a62a1d3af400ef"
                }
            ],
            "config-opts": [
                "--disable-tests"
            ]
        },
        {
            "name": "intel-vaapi-driver",
            "only-arches": ["x86_64", "i386"],
            "buildsystem": "meson",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/intel/intel-vaapi-driver.git",
                    "branch": "9a1f0c64174f970a26380d4957583c71372fbb7c"
                }
            ]
        },
        {
            "name": "gstreamer",
            "buildsystem": "meson",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://gstreamer.freedesktop.org/src/gstreamer/gstreamer-1.16.1.tar.xz",
                    "sha256": "02211c3447c4daa55919c5c0f43a82a6fbb51740d57fc3af0639d46f1cf4377d"
                }
            ],
            "config-opts": [
                "-Dgtk_doc=disabled",
                "-Dintrospection=disabled",
                "-Dnls=disabled"
            ]
        },
        {
            "name": "gst-plugins-base",
            "buildsystem": "meson",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://gstreamer.freedesktop.org/src/gst-plugins-base/gst-plugins-base-1.16.2.tar.xz",
                    "sha256": "b13e73e2fe74a4166552f9577c3dcb24bed077021b9c7fa600d910ec6987816a"
                },
                {
                    "type": "patch",
                    "path": "gstreamer-patches/gst-plugins-base-0001-glupload-Fix-fallback-from-direct-dmabuf-to-dmabuf-u.patch"
                },
                {
                    "type": "patch",
                    "path": "gstreamer-patches/gst-plugins-base-0001-oggstream-Workaround-for-broken-PAR-in-VP8-BOS.patch"
                },
                {
                    "type": "patch",
                    "path": "gstreamer-patches/gst-plugins-base-0001-playbin-Handle-error-message-with-redirection-indica.patch"
                },
                {
                    "type": "patch",
                    "path": "gstreamer-patches/gst-plugins-base-0002-glupload-fix-segfault.patch"
                },
                {
                    "type": "patch",
                    "path": "gstreamer-patches/gst-plugins-base-0003-glbasefilter-add-support-for-changing-the-display.patch"
                }
            ],
            "config-opts": [
                "-Dgtk_doc=disabled",
                "-Dintrospection=disabled"
            ]
        },
        {
            "name": "gst-plugins-good",
            "buildsystem": "meson",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://gstreamer.freedesktop.org/src/gst-plugins-good/gst-plugins-good-1.16.2.tar.xz",
                    "sha256": "40bb3bafda25c0b739c8fc36e48380fccf61c4d3f83747e97ac3f9b0171b1319"
                },
                {
                    "type": "patch",
                    "path": "gstreamer-patches/gst-plugins-good-qtdemux-Specify-REDIRECT-information-in-error-messag.patch"
                }
            ],
            "config-opts": [
                "-Dnls=disabled"
            ]
        },
        {
            "name": "libwpe",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_C_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_CXX_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_INSTALL_PREFIX=/usr"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://wpewebkit.org/releases/libwpe-1.8.0.tar.xz",
                    "sha256": "a6f00a7d091cbd4db57fe7ee3b4c12c6350921d654ed79812800a26c888481d2"
                }
            ]
        },
        {
            "name": "wpebackend-fdo",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_C_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_CXX_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_INSTALL_PREFIX=/usr"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://wpewebkit.org/releases/wpebackend-fdo-1.8.0.tar.xz",
                    "sha256": "9652a99c75fe1c6eab0585b6395f4e104b2427e4d1f42969f1f77df29920d253"
                }
            ]
        },
        {
            "name": "brotli",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/google/brotli/archive/v1.0.9.tar.gz",
                    "sha256": "f9e8d81d0405ba66d181529af42a3354f838c939095ff99930da6aa9cdf6fe46"
                }
            ],
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_C_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_CXX_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_INSTALL_PREFIX=/usr"
            ]
        },
        {
            "name": "woff2",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/google/woff2/archive/v1.0.2.tar.gz",
                    "sha256": "add272bb09e6384a4833ffca4896350fdb16e0ca22df68c0384773c67a175594"
                }
            ],
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_C_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_CXX_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_INSTALL_PREFIX=/usr"
            ]
        },
        {
            "name": "wpewebkit",
            "buildsystem": "cmake-ninja",
            "builddir": true,
            "sources": [
                {
                    "type": "archive",
                    "url": "https://wpewebkit.org/releases/wpewebkit-2.30.1.tar.xz",
                    "sha256": "78c0135d935b980fc64fbddf1fbaf441920edda4eeb4c16857ee8dc985650c25"
                }
            ],
            "config-opts": [
                "-DPORT=WPE",
                "-DCMAKE_BUILD_TYPE=Release",
                "-DCMAKE_C_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_CXX_FLAGS_RELEASE=-DNDEBUG",
                "-DCMAKE_INSTALL_PREFIX=/usr",
                "-DUSE_OPENJPEG=OFF"
            ],
            "build-options": {
                "arch": {
                    "arm": {
                        "cflags": "-g1",
                        "cxxflags": "-g1"
                    },
                    "aarch64": {
                        "cflags": "-g1",
                        "cxxflags": "-g1"
                    }
                }
            }
        },
        {
            "name": "rtmpdump",
            "buildsystem": "simple",
            /* FIXME: Make libdir truly generic, hardcoding the triplet here is bad... */
            "build-commands": [
                "make prefix=/usr libdir=/usr/lib/x86_64-linux-gnu CRYPTO=GNUTLS install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://git.ffmpeg.org/rtmpdump.git",
                    "branch": "c5f04a58fc2aeea6296ca7c44ee4734c18401aa3"
                }
            ]
        },
        {
            "name": "gst-plugins-bad",
            "buildsystem": "meson",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://gstreamer.freedesktop.org/src/gst-plugins-bad/gst-plugins-bad-1.16.2.tar.xz",
                    "sha256": "f1cb7aa2389569a5343661aae473f0a940a90b872001824bc47fa8072a041e74"
                },
                {
                    "type": "patch",
                    "path": "gstreamer-patches/gst-plugins-bad-0001-h264parse-Post-a-WARNING-when-data-is-broken.patch"
                }
            ],
            "config-opts": [
                "-Dgtk_doc=disabled",
                "-Dintrospection=disabled",
                "-Dvulkan=disabled"
            ]
        },
        {
            "name": "gstreamer-vaapi",
            "buildsystem": "meson",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://gstreamer.freedesktop.org/src/gstreamer-vaapi/gstreamer-vaapi-1.16.2.tar.xz",
                    "sha256": "191de7b0ab64a85dd0875c990721e7be95518f60e2a9106beca162004ed7c601"
                }
            ]
        },
        {
            "name": "adwaita-icon-theme",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://ftp.gnome.org/pub/GNOME/sources/adwaita-icon-theme/3.34/adwaita-icon-theme-3.34.0.tar.xz",
                    "sha256": "40b7e91f8263552b64d0f9beff33150291b086618ce498c71bf10035e48c7c7f"
                }
            ]
        },
        {
            "name": "os-release",
            "sources": [
                {
                    "type": "file",
                    "path": "os-release"
                },
                {
                    "type": "file",
                    "path": "issue"
                },
                {
                    "type": "file",
                    "path": "issue.net"
                },
                {
                    "type": "file",
                    "path": "org.wpe.Sdk.appdata.xml"
                },
                {
                    "type": "file",
                    "path": "org.wpe.Platform.appdata.xml"
                },
                {
                    "type": "file",
                    "path": "os-release-configure",
                    "dest-filename": "configure"
                }
            ]
        }
    ]
}
